<div class="app-component" data-component="tweet-collection" style="display:contents;">
<div class="tweet-collection-container">
  <div class="content-card">
    <!-- Header -->
    <div class="header">
      <div class="header-inner">
        <div class="header-left">
          <div class="header-icon">ğŸ“ˆ</div>
          <div class="header-text">
            <h1>Tweet Collection & Management</h1>
            <p class="subtitle">Collect, organize, and analyze tweets from Twitter API</p>
          </div>
        </div>

        <div class="header-cta">
          <button class="btn-create" (click)="showCreateDatasetForm()">â• Create New Dataset</button>
        </div>
      </div>
    </div>


  <!-- API Rate Limits -->
  <div class="rate-limits-section" style="background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;">
    <div class="rate-limits-header" style="padding: 10px; border-bottom: 1px solid #ddd; background: #f0f0f0; cursor: pointer;" (click)="toggleRateLimits()">
      <strong>ğŸ“Š X/Twitter API Rate Limits</strong>
      <span style="float: right;">{{ showRateLimits ? 'â–¼' : 'â–¶' }}</span>
    </div>
    <div *ngIf="showRateLimits" class="rate-limits-content" style="padding: 10px;">
      <div *ngIf="rateLimits.length === 0" class="loading-message" style="text-align: center; color: #666; padding: 10px;">
        Loading rate limits...
      </div>
      <div *ngIf="rateLimits.length > 0" class="rate-limits-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
        <div *ngFor="let limit of rateLimits" class="rate-limit-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px;">
          <div class="rate-limit-endpoint" style="font-weight: bold; color: #333; margin-bottom: 5px;">
            {{ limit.endpoint }}
          </div>
          
          <!-- Configuration Required Message -->
          <div *ngIf="limit.endpoint === 'Configuration Required'" class="config-required" style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 10px;">âš™ï¸</div>
            <div style="color: #666; margin-bottom: 10px;">{{ limit.resetTime }}</div>
            <button class="btn-primary" (click)="goToApiConfig()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
              Configure API Credentials
            </button>
          </div>
          
          <!-- Normal Rate Limit Display -->
          <div *ngIf="limit.endpoint !== 'Configuration Required'" class="rate-limit-info">
            <div class="rate-limit-remaining" [style.color]="limit.remaining < limit.limit * 0.2 ? '#d32f2f' : (limit.remaining < limit.limit * 0.5 ? '#f57c00' : '#388e3c')">
              <strong>{{ limit.remaining }}</strong> / {{ limit.limit }} requests remaining
            </div>
            <div class="rate-limit-reset" style="font-size: 12px; color: #666; margin-top: 2px;">
              Resets: {{ limit.resetTime }}
            </div>
            <div class="rate-limit-progress" style="width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; margin-top: 5px; overflow: hidden;">
              <div class="rate-limit-bar" 
                   [style.width.%]="(limit.remaining / limit.limit) * 100"
                   [style.background-color]="limit.remaining < limit.limit * 0.2 ? '#d32f2f' : (limit.remaining < limit.limit * 0.5 ? '#f57c00' : '#388e3c')">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="rate-limits-footer" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
        <button class="btn-secondary" (click)="loadRateLimits()" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
          ğŸ”„ Refresh Rate Limits
        </button>
        <span style="margin-left: 10px;" *ngIf="!hasConfigurationRequired()">Rate limits are updated after each API call</span>
        <span style="margin-left: 10px;" *ngIf="hasConfigurationRequired()">Configure your Twitter API credentials to view rate limits</span>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    âœ… {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-error">
    âŒ {{ errorMessage }}
  </div>

  <!-- Navigation Breadcrumb -->
  <div class="breadcrumb">
    <span class="breadcrumb-item" 
          [class.active]="currentView === 'datasets'"
          (click)="backToDatasets()">
      ğŸ“ Datasets
    </span>
    <span *ngIf="currentView !== 'datasets'" class="breadcrumb-separator">â€º</span>
    <span *ngIf="currentView === 'collect'" class="breadcrumb-item active">ğŸ” Collect Tweets</span>
    <span *ngIf="currentView === 'manage'" class="breadcrumb-item active">âš™ï¸ Manage {{ selectedDataset?.name }}</span>
  </div>

  <!-- Dataset List View -->
  <div *ngIf="currentView === 'datasets'" class="datasets-view">
    
    <div class="view-header">
      <h2>Your Tweet Datasets</h2>
      <button class="btn-primary" (click)="showCreateDatasetForm()">
        â• Create New Dataset
      </button>
    </div>

    <!-- Create Dataset Form -->
    <div *ngIf="showCreateDataset" class="create-dataset-form">
      <h3>Create New Dataset</h3>
      <div class="form-group">
        <label for="datasetName">Dataset Name</label>
        <input 
          id="datasetName"
          type="text" 
          [(ngModel)]="newDatasetName"
          placeholder="e.g., COVID-19 Public Opinion"
          class="form-input">
      </div>
      <div class="form-group">
        <label for="datasetDescription">Description (optional)</label>
        <textarea 
          id="datasetDescription"
          [(ngModel)]="newDatasetDescription"
          placeholder="Describe what this dataset is for..."
          rows="3"
          class="form-textarea"></textarea>
      </div>
      <div class="form-actions">
        <button class="btn-primary" (click)="createDataset()" [disabled]="!newDatasetName.trim()">
          Create Dataset
        </button>
        <button class="btn-secondary" (click)="hideCreateDatasetForm()">
          Cancel
        </button>
      </div>
    </div>

    <!-- Dataset Grid -->
    <div class="datasets-grid">
      <div *ngFor="let dataset of datasets" class="dataset-card">
        <div class="dataset-header">
          <h3>{{ dataset.name }}</h3>
          <div class="dataset-stats">
            <span class="stat">ğŸ“Š {{ dataset.tweet_count }} tweets</span>
          </div>
        </div>
        
        <div class="dataset-info">
          <p *ngIf="dataset.description" class="dataset-description">{{ dataset.description }}</p>
          <div class="dataset-meta">
            <span class="meta-item">ğŸ“… Created: {{ formatDate(dataset.created_at) }}</span>
            <span class="meta-item" *ngIf="dataset.keywords">ğŸ” Keywords: {{ dataset.keywords }}</span>
          </div>
        </div>

        <div class="dataset-actions">
          <button class="btn-primary" (click)="selectDataset(dataset)">
            âš™ï¸ Manage Tweets
          </button>
          <button class="btn-outline" (click)="selectedDataset = dataset; goToCollection()">
            â• Add Tweets
          </button>
          <button class="btn-ghost" (click)="analyzeDataset(dataset)" [disabled]="isAnalyzingDatasets[dataset.id]">
            <span *ngIf="!isAnalyzingDatasets[dataset.id]">ğŸ§  Analyze</span>
            <span *ngIf="isAnalyzingDatasets[dataset.id]">â³ Analyzing...</span>
          </button>
          <button class="btn-danger" (click)="deleteDataset(dataset)">
            ğŸ—‘ï¸ Delete
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="datasets.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <h3>No datasets yet</h3>
        <p>Create your first dataset to start collecting tweets</p>
        <button class="btn-primary" (click)="showCreateDatasetForm()">
          â• Create Your First Dataset
        </button>
      </div>
    </div>
  </div>

  <!-- Tweet Collection View -->
  <div *ngIf="currentView === 'collect'" class="collection-view">
    
    <div class="view-header">
      <h2>ğŸ” Collect Tweets</h2>
      <p *ngIf="selectedDataset">Adding to dataset: <strong>{{ selectedDataset.name }}</strong></p>
      <button class="btn-secondary" (click)="backToDatasets()">â† Back to Datasets</button>
    </div>

    <!-- Dataset Selection -->
    <div *ngIf="!selectedDataset" class="dataset-selection">
      <h3>Select a dataset to add tweets to:</h3>
      <div class="dataset-options">
        <div *ngFor="let dataset of datasets" 
             class="dataset-option"
             (click)="selectedDataset = dataset">
          <h4>{{ dataset.name }}</h4>
          <span class="tweet-count">{{ dataset.tweet_count }} tweets</span>
        </div>
      </div>
    </div>

    <!-- Collection Form -->
    <div *ngIf="selectedDataset" class="collection-form">
      <div class="form-group">
        <label for="keyword">Search Keyword</label>
        <input 
          id="keyword"
          type="text" 
          [(ngModel)]="keyword"
          placeholder="e.g., covid, jakarta, #vaksin"
          class="form-input"
          [disabled]="isCollecting">
      </div>

      <div class="form-group">
        <label for="maxResults">Number of Tweets</label>
        <select id="maxResults" [(ngModel)]="maxResults" class="form-select" [disabled]="isCollecting">
          <option value="10">10 tweets</option>
          <option value="25">25 tweets</option>
          <option value="50">50 tweets</option>
          <option value="100">100 tweets (max)</option>
        </select>
      </div>

      <div class="form-actions">
        <button class="btn-primary" 
                (click)="collectTweets()" 
                [disabled]="!keyword.trim() || isCollecting">
          <span *ngIf="!isCollecting">ğŸ” Collect Tweets</span>
          <span *ngIf="isCollecting">â³ Collecting...</span>
        </button>
      </div>

      <!-- Progress -->
      <div *ngIf="collectionProgress" class="collection-progress">
        <div class="progress-text">{{ collectionProgress }}</div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="isCollecting ? 50 : 100"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tweet Management View -->
  <div *ngIf="currentView === 'manage'" class="management-view">
    
    <div class="view-header">
      <h2>âš™ï¸ Manage {{ selectedDataset?.name }}</h2>
      <div class="header-actions">
        <button class="btn-outline" (click)="goToCollection()">â• Add More Tweets</button>
        <button class="btn-secondary" (click)="backToDatasets()">â† Back to Datasets</button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-box">
        <input 
          type="text" 
          [(ngModel)]="searchFilter"
          (input)="applyFilter()"
          placeholder="ğŸ” Search tweets..."
          class="search-input">
      </div>
      
      <div class="selection-info">
        <span *ngIf="selectedTweets.length > 0" class="selected-count">
          {{ selectedTweets.length }} selected
        </span>
      </div>

      <div class="toolbar-actions">
        <button class="btn-outline small" (click)="selectAllTweets()">
          {{ selectAllButtonText }}
        </button>
        <button class="btn-danger small" 
                (click)="deleteTweets()" 
                [disabled]="selectedTweets.length === 0">
          ğŸ—‘ï¸ Delete Selected
        </button>
        <button class="btn-primary" 
                (click)="analyzeSelectedTweets()" 
                [disabled]="selectedTweets.length < 20">
          ğŸ“Š Analyze Selected ({{ selectedTweets.length }})
        </button>
      </div>
    </div>

    <!-- Tweet Table -->
    <div class="tweet-table-container">
      <table class="tweet-table">
        <thead>
          <tr>
            <th width="40">
              <input type="checkbox" 
                     [checked]="allPaginatedTweetsSelected"
                     (change)="selectAllTweets()">
            </th>
            <th width="100">Date</th>
            <th width="120">Username</th>
            <th>Tweet Text</th>
            <th width="100">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tweet of paginatedTweets; trackBy: trackByTweetId" 
              [class.selected]="tweet.selected"
              [class.edited]="tweet.edited">
            <td>
              <input type="checkbox" 
                     [checked]="tweet.selected"
                     (change)="toggleTweetSelection(tweet)">
            </td>
            <td class="date-cell">{{ formatDate(tweet.created_at) }}</td>
            <td class="username-cell">{{ tweet.username || 'N/A' }}</td>
            <td class="text-cell">
              <div *ngIf="editingTweet !== tweet" class="tweet-text">
                {{ tweet.text }}
                <span *ngIf="tweet.edited" class="edited-badge">âœï¸ Edited</span>
              </div>
              <textarea *ngIf="editingTweet === tweet" 
                        [(ngModel)]="tweet.text"
                        class="edit-textarea"
                        rows="3"></textarea>
            </td>
            <td class="actions-cell">
              <div *ngIf="editingTweet !== tweet" class="action-buttons">
                <button class="btn-icon" (click)="editTweet(tweet)" title="Edit tweet">
                  âœï¸
                </button>
              </div>
              <div *ngIf="editingTweet === tweet" class="edit-actions">
                <button class="btn-icon success" (click)="saveTweetEdit()" title="Save">
                  âœ…
                </button>
                <button class="btn-icon danger" (click)="cancelTweetEdit()" title="Cancel">
                  âŒ
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div *ngIf="filteredTweets.length === 0" class="empty-tweets">
        <div *ngIf="tweets.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ¦</div>
          <h3>No tweets in this dataset</h3>
          <p>Start collecting tweets to see them here</p>
          <button class="btn-primary" (click)="goToCollection()">
            ğŸ” Collect Tweets
          </button>
        </div>
        <div *ngIf="tweets.length > 0 && filteredTweets.length === 0" class="no-results">
          <div class="empty-icon">ğŸ”</div>
          <h3>No tweets match your search</h3>
          <p>Try different search terms</p>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="totalPages > 1" class="pagination">
      <button class="btn-page" 
              (click)="changePage(currentPage - 1)" 
              [disabled]="currentPage <= 1">
        â† Previous
      </button>
      
      <span class="page-info">
        Page {{ currentPage }} of {{ totalPages }}
        ({{ filteredTweets.length }} tweets)
      </span>
      
      <button class="btn-page" 
              (click)="changePage(currentPage + 1)" 
              [disabled]="currentPage >= totalPages">
        Next â†’
      </button>
    </div>

    <!-- Analysis Info -->
    <div *ngIf="selectedTweets.length > 0" class="analysis-info">
      <div class="info-card">
        <h4>Ready for Analysis?</h4>
        <p>
          <span *ngIf="selectedTweets.length < 20" class="warning">
            âš ï¸ Select at least 20 tweets for meaningful analysis. Currently selected: {{ selectedTweets.length }}
          </span>
          <span *ngIf="selectedTweets.length >= 20" class="success">
            âœ… {{ selectedTweets.length }} tweets selected - ready for sentiment analysis!
          </span>
        </p>
      </div>
    </div>
  </div>

  <!-- Library Selection Modal -->
  </div> <!-- /.content-card -->

  <!-- Library Selection Modal -->
  <div *ngIf="showLibrarySelection" class="modal-overlay" (click)="closeLibrarySelection()">
    <div class="modal-content library-selection-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ“š Select Word Library for Analysis</h3>
        <button class="close-btn" (click)="closeLibrarySelection()">Ã—</button>
      </div>

      <div class="modal-body">
        <p class="modal-description">
          Choose an existing word library or create a new one for sentiment analysis of {{ selectedTweets.length }} tweets.
        </p>

        <!-- Library Selection Toggle -->
        <div class="import-method-toggle">
          <button 
            class="toggle-btn"
            [class.active]="librarySelectionMode === 'existing'"
            (click)="librarySelectionMode = 'existing'"
            [disabled]="wordLibraries.length === 0">
            ğŸ“š Use Existing Library
          </button>
          <button 
            class="toggle-btn"
            [class.active]="librarySelectionMode === 'new'"
            (click)="librarySelectionMode = 'new'">
            â• Create New Library
          </button>
        </div>

        <!-- Existing Library Selection -->
        <div *ngIf="librarySelectionMode === 'existing' && wordLibraries.length > 0" class="existing-library">
          <h4>Select a Library:</h4>
          <div class="library-cards">
            <div *ngFor="let lib of wordLibraries" 
                 class="library-card"
                 [class.selected]="selectedLibraryId === lib.id"
                 (click)="selectedLibraryId = lib.id">
              <div class="library-card-header">
                <div class="selection-indicator" *ngIf="selectedLibraryId === lib.id">âœ“</div>
                <strong>{{ lib.name }}</strong>
              </div>
              <div class="library-card-body">
                <div class="library-stats">
                  <span>ğŸ“Š {{ lib.sample_count || 0 }} samples</span>
                  <span>ğŸ“… {{ lib.created_at | date:'short' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- New Library Creation -->
        <div *ngIf="librarySelectionMode === 'new' || wordLibraries.length === 0" class="new-library">
          <h4>Create New Library:</h4>
          <div class="form-group">
            <label>Library Name *</label>
            <input 
              type="text" 
              [(ngModel)]="newLibraryName" 
              placeholder="e.g., My Tweet Analysis Library"
              class="form-control">
          </div>
          <p class="info-text">
            â„¹ï¸ A new word library will be created and populated with labeled samples from your tweet analysis.
          </p>
        </div>

        <!-- Analysis Progress -->
        <div *ngIf="isAnalyzing" class="analysis-progress">
          <div class="progress-spinner"></div>
          <p>{{ analysisProgress }}</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeLibrarySelection()" [disabled]="isAnalyzing">
          Cancel
        </button>
        <button class="btn-primary" 
                (click)="startAnalysisWithLibrary()" 
                [disabled]="isAnalyzing || (librarySelectionMode === 'existing' && !selectedLibraryId) || (librarySelectionMode === 'new' && !newLibraryName.trim())">
          {{ isAnalyzing ? 'Starting...' : 'Start Analysis' }}
        </button>
      </div>
    </div>
  </div>

</div>